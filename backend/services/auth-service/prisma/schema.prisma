generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique @db.VarChar(50)
  email         String   @unique @db.VarChar(255)
  passwordHash  String   @map("password_hash") @db.VarChar(255)
  
  // Profile
  avatarUrl     String?  @map("avatar_url") @db.VarChar(500)
  bio           String?  @db.Text
  country       String?  @db.VarChar(2)
  
  // Stats
  rating        Int      @default(1200)
  rank          String   @default("bronze") @db.VarChar(20)
  wins          Int      @default(0)
  losses        Int      @default(0)
  totalBattles  Int      @default(0) @map("total_battles")
  
  // Metadata
  isVerified    Boolean  @default(false) @map("is_verified")
  isActive      Boolean  @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  battlesAsPlayer1  Battle[] @relation("Player1Battles")
  battlesAsPlayer2  Battle[] @relation("Player2Battles")
  submissions       Submission[]

  @@index([username])
  @@index([email])
  @@index([rating(sort: Desc)])
  @@map("users")
}

model Problem {
  id          String   @id @default(uuid())
  title       String   @db.VarChar(200)
  slug        String   @unique @db.VarChar(200)
  difficulty  String   @db.VarChar(20) // easy, medium, hard
  description String   @db.Text
  
  // Code templates for different languages
  templateJs  String?  @map("template_js") @db.Text
  templatePy  String?  @map("template_py") @db.Text
  templateJava String? @map("template_java") @db.Text
  templateCpp String?  @map("template_cpp") @db.Text
  
  // Constraints and hints
  constraints String?  @db.Text
  hints       String?  @db.Text
  examples    String?  @db.Text
  
  // Metadata
  tags        String[] // Array of tags
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  testCases   TestCase[]
  battles     Battle[]

  @@index([difficulty])
  @@index([slug])
  @@map("problems")
}

model TestCase {
  id          String   @id @default(uuid())
  problemId   String   @map("problem_id")
  input       String   @db.Text
  output      String   @db.Text
  isExample   Boolean  @default(false) @map("is_example")
  isHidden    Boolean  @default(false) @map("is_hidden")
  orderIndex  Int      @default(0) @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  problem     Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([problemId])
  @@map("test_cases")
}

model Battle {
  id          String   @id @default(uuid())
  
  // Players
  player1Id   String   @map("player1_id")
  player2Id   String   @map("player2_id")
  
  // Problem
  problemId   String   @map("problem_id")
  
  // Battle details
  mode        String   @db.VarChar(50) // solo, ranked, practice
  difficulty  String?  @db.VarChar(20)
  
  // Status
  status      String   @db.VarChar(20) // countdown, active, completed, abandoned
  winnerId    String?  @map("winner_id")
  
  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  player1     User       @relation("Player1Battles", fields: [player1Id], references: [id])
  player2     User       @relation("Player2Battles", fields: [player2Id], references: [id])
  problem     Problem    @relation(fields: [problemId], references: [id])
  submissions Submission[]

  @@index([player1Id])
  @@index([player2Id])
  @@index([problemId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("battles")
}

model Submission {
  id              String   @id @default(uuid())
  battleId        String   @map("battle_id")
  userId          String   @map("user_id")
  
  // Submission details
  code            String   @db.Text
  language        String   @db.VarChar(20)
  
  // Results
  testsPassed     Int      @default(0) @map("tests_passed")
  testsTotal      Int      @default(0) @map("tests_total")
  completionTime  Int      @map("completion_time") // milliseconds from battle start
  
  // Status
  status          String   @db.VarChar(20) // pending, running, completed, error
  errorMessage    String?  @map("error_message") @db.Text
  
  // Timestamps
  submittedAt     DateTime @default(now()) @map("submitted_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  battle          Battle   @relation(fields: [battleId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id])

  @@index([battleId])
  @@index([userId])
  @@index([submittedAt(sort: Desc)])
  @@map("submissions")
}
